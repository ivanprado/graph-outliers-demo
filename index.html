<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN"
   "http://www.w3.org/TR/html4/strict.dtd">

<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">

<!-- Le styles -->
<link href="css/bootstrap.css" rel="stylesheet">
<style>
  body {
  padding-top: 60px; /* 60px to make the container go all the way to the bottom of the topbar */
  }
</style>
<link href="css/bootstrap-responsive.css" rel="stylesheet">

<title>Social graph outlier detection tutorial</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="">
<meta name="author" content="Datasalt Systems S.L.">

<script src="lib/jquery.js"></script>
<script src="lib/bootstrap.min.js"></script>
<script src="lib/arbor.js"></script>
<script src="lib/raphael-min.js"></script>
<script src="lib/g.raphael-min.js"></script>
<script src="lib/g.line-min.js"></script>
<script src="graphs.js"></script>
<script src="stats.js"></script>
<script src="renderer.js"></script>

<script>
function renderGraph(sys) {
	$.getJSON('/data.json', function(data) {
		// create the graph as a JavaScript object
	    var graph = {};
	
	    $.each(data, function(key, val) {
	    	    // add some nodes to the graph and watch it go...
				if(val.uid1 == "Pere Ferrera Bertran" || val.uid2 == "Pere Ferrera Bertran") {
					return;
				}
				if(!graph[val.uid1]) {
					graph[val.uid1] = {};
				}
				graph[val.uid1][val.uid2] = val.uid2;
				if(!graph[val.uid2]) {
					graph[val.uid2] = {};
				}
				graph[val.uid2][val.uid1] = val.uid1;
		});    	
	
		// calculate number of nodes
		var nodes = 0;
		// create a convenient lookup by node index
		var nodeByIndex = {};
		for(var node in graph) {
			nodeByIndex[nodes] = node;
			nodes++;
		}
	
		var features = computeFeatures(graph);
		var rankInfo = largestEigenValue(graph, nodeByIndex);
		var centrality = betweennessCentrality(graph, nodeByIndex, nodes);
		
	    mainStats(graph, features, rankInfo, centrality);
	
		// Outliers
		
		features.nodeFeatures.sort(function(a, b) {
			return a.degree - b.degree;
		});
	
		// --- gRaphael chart --- http://www.cs.stonybrook.edu/~leman/icdm12/ICDM12-Tutorial%20-%20PartI.pdf
		
		var r = Raphael("chart"), txtattr = {
			font : "12px sans-serif"
		};
	
		var x = [], y = [], y2 = [];
		var lookup = [];
		for(var i = 0; i < features.nodeFeatures.length; i++) {
			x[i] = features.nodeFeatures[i].degree;
			y[i] = features.nodeFeatures[i].egonetLinks;
			if(!lookup[features.nodeFeatures[i].egonetLinks]) {
				lookup[features.nodeFeatures[i].egonetLinks] = [];
			}
			lookup[features.nodeFeatures[i].egonetLinks].push( features.nodeFeatures[i] );
		}
		var regression = leastSquares(x, y);
		
		for(var i = 0; i < x.length; i++) {
			y2[i] = regression.a * x[i] + regression.b;
		}
		
		r.linechart(10, 10, 600, 220, x, [ y, y2 ], { nostroke: false, axis: "0 0 1 1", symbol: "circle", smooth: true }).hoverColumn(function () {
			var html = "";
			var total = 0;
			for(var k = 0; k < this.values.length / 2; k++) {
				for( var m = 0; m < lookup[this.values[k]].length; m++ ) {
					html += "<li> " + lookup[this.values[k]][m].node + " (" + this.values[k] + " ego-links, " + lookup[this.values[k]][m].degree + " common f.)</li>";
					total++;
					if(total == 10) {
						break;
					}
				}
				if(total == 10) {
					break;
				}
			}
			$("#explanation").html("<ul>" + html + "</ul>");
		}, function () {
			$("#explanation").html("");
	    });
	
		// ---- eigenvalue graph. Note: for some reason variable reusing in JavaScript made weird things to me. --- //
	
		
		features.nodeFeatures.sort(function(a, b) {
			return a.egonetLinks - b.egonetLinks;
		});
		
		var rb = Raphael("chart_2");
	
		var xb = [], yb = [], y2b = [];
		var lookupb = [];
		
		for(var i = 0; i < features.nodeFeatures.length; i++) {
			xb[i] = features.nodeFeatures[i].averageEgonetDegree;
			yb[i] = features.nodeFeatures[i].largestEigenvalue;
			if(!lookupb[features.nodeFeatures[i].largestEigenvalue]) {
				lookupb[features.nodeFeatures[i].largestEigenvalue] = [];
			}
			lookupb[features.nodeFeatures[i].largestEigenvalue].push( features.nodeFeatures[i] );
		}
		
		for(var i = 0; i < x.length; i++) {
			y2b[i] = xb[i];
		}
		
		rb.linechart(10, 10, 600, 220, xb, [ yb, y2b ], { nostroke: false, axis: "0 0 1 1", symbol: "circle", smooth: true }).hoverColumn(function () {
			var html = "";
			var total = 0;
			for(var k = 0; k < this.values.length / 2; k++) {
				for( var m = 0; m < lookupb[this.values[k]].length; m++ ) {
					html += "<li> " + lookupb[this.values[k]][m].node + " (" + this.values[k] + " largest eigenvalue)</li>";
					total++;
					if(total == 10) {
						break;
					}
				}
				if(total == 10) {
					break;
				}
			}
			$("#explanation_2").html("<ul>" + html + "</ul>");
		}, function () {
			$("#explanation_2").html("");
	    });
		
		for(var node in graph) {
		    sys.addNode(node, {label:node});
		    for(var neighbor in graph[node]) {
		    	sys.addEdge(node, neighbor);
		    }
		}
	})
	.error(function() { alert("Error loading JSON data."); })
}
</script>
</head>
<body>
<div class="container">
 	<h1>Your mutual friends social graph</h1>
 	
	<div class="row">
  		<div class="span8"><canvas id="viewport" width="800" height="600"></canvas></div>
  		<div class="span4">
  			<div id="stats">
  				<div id="main-stats">
  				</div>
  				<a href="betweenness.html">Central nodes:</a>
  				<div id="central-nodes">
  				</div>
  				<a href="#">Influencers:</a>
  				<div id="influencers">
  				</div>
  			</div>
  		</div>
	</div>
	
	<div class="raphael">
		<h2>Highly / loosely connected egonets</h2>
	
		<p><b>X = #common friends, y = #links in egonet. Blue is actual data, green is regression line.</b></p>
		
		<p>This is an analysis on the <a href='clustering.html'>clustering</a> of each of your friend's egonet. The egonet is the graph of mutual friends. How are mutual friends interconnected?</p>
		
		<p>This graph is a regression on the size of the egonet versus the number of common friends.</p>
		<ul>
			<li><b>Higher slope:</b> These are friends whose mutual friends are highly connected. In the case of your social network, this probably means a friend whom you have only a certain group of friends in common. For instance, someone you knew in one past work.</li>
			<li><b>Lower slope:</b> These are friends whose mutual friends are <b>not</b> highly connected. In the case of your social network, this probably means a friend whom you have several, disjoint groups of friends in common. For instance, your girlfriend/boyfriend, with whom you share several aspects of your life.</li>
		</ul>
	
		<div class="row">
			<div class="span7">
				<div id="chart">
				</div>
			</div>
			<div id="explanation" class="span4">
			</div>
		</div>

		<h2>Balanced / unbalanced communities</h2>

		<p><b>X = #average degree in egonet, y = largest eigenvalue of egonet. Blue is actual data, green is y = x line.</b></p>

		<p>This is an analysis on the topology of each of your friend's egonet, based on the <a href='eigenvalue.html'>largest eigenvalue of it.</a></p>
		
		<p>The closer the largest eigenvalue to the average degree of the egonet, the more balanced the egonet is. Unbalanced egonets will be usually larger groups of mutual friends, as the likelihood of everyone knowing everyone else decreases with the size of the community.</p> 
		
		<div class="row">
			<div class="span7">
				<div id="chart_2">
				</div>
			</div>
			<div id="explanation_2" class="span4">
			</div>
		</div>
	</div>

</div>
</body>
</html>
